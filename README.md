# Dubcast UI (Front-End)

SPA-приложение для веб-радио **Dubcast**, реализованное на **Angular + TypeScript**.  
Функциональность включает: радио-плеер (SoundCloud), чат, профиль пользователя, подсчёт слушателей в реальном времени (WebSocket/STOMP), затемнённый/размытый фон по обложке текущего трека.

---

## Быстрый старт

### Требования
- Node.js (LTS)
- npm
- Angular CLI (опционально, можно через `npx`)

### Установка и запуск
```bash
npm install
npm start
```

По умолчанию dev-сервер: `http://localhost:4200`.

### Прокси на backend (рекомендуется)
Если backend работает на `http://localhost:8080`, добавьте прокси (пример): `proxy.conf.json`
```json
{
  "/api": {
    "target": "http://localhost:8080",
    "secure": false,
    "changeOrigin": true
  },
  "/radio-ws": {
    "target": "http://localhost:8080",
    "secure": false,
    "changeOrigin": true,
    "ws": true
  }
}
```
Запуск с прокси:
```bash
npm start -- --proxy-config proxy.conf.json
```

---

## Структура проекта (в общих чертах)

- `src/app/app.ts`, `app.html`, `app.module.ts` — корневой компонент/модуль
- `src/app/features/public/*` — публичная часть (radio/login/register/profile/chat)
- `src/app/shared/*` — переиспользуемые компоненты (mini-player, global-player, online-listeners, soundcloud-player и т.д.)
- `src/app/core/*` — сервисы: auth, audio/player, analytics, background, user identity/profile и т.д.
- `src/e2e/e2e/*` — Playwright e2e тесты
- `src/playwright.config.ts` — конфигурация Playwright

---

# Документация Front-End приложения Dubcast

Ниже приведён текст для пояснительной записки / README (архитектура, подход, API, user flows, стек).  
*(Раздел дополнен информацией о тестировании и фактической структуре проекта.)*

## 1. Архитектурная схема

Приложение разработано как **Single Page Application (SPA)** с использованием фреймворка **Angular**. Архитектура следует **модульному принципу** для обеспечения масштабируемости и поддерживаемости кода.

### Структура модулей
- **AppModule**: Корневой модуль приложения, точка входа.
- **Features Modules**: Модули, группирующие функциональность по бизнес-доменам:
  - **PublicModule**: Содержит публичную часть приложения (страницы входа, регистрации, профиль, виджет радио, чат).
  - **SharedModule**: Содержит общие UI-компоненты, директивы и пайпы (например: mini-player, soundcloud-player, online-listeners и т.д.).

### Основные компоненты
- **Layouts**: Компоненты-обёртки для структуры страниц (например, `PublicLayout`).
- **Pages (Контейнеры)**:
  - `LoginPage`: Страница авторизации.
  - `RegisterPage`: Страница регистрации.
  - `ProfilePage`: Редактирование профиля (username + bio).
  - `RadioPage`: Главная страница с радио.
- **UI Components (Presentational)**:
  - `RadioWidgetComponent`: UI “now playing”, управление воспроизведением, громкостью, отображение обложки.
  - `GlobalPlayerComponent`: Глобальный плеер, который живёт поверх роутинга и продолжает играть при переходах по страницам.
  - `OnlineListenersComponent`: Отображение текущего количества слушателей (реалтайм статистика).
  - `MiniPlayerComponent`: Мини-плеер в шапке (быстрый доступ к Play/Pause и громкости).

### Маршрутизация (Routes)
Навигация настроена через `RouterModule`. Основные маршруты:
- `/radio` — Главная страница приложения (радио)
- `/login` — Страница входа.
- `/register` — Страница регистрации.
- `/profile` — Страница профиля.

### Управление состоянием
Используется реактивный подход на базе **RxJS**.

- **Глобальное состояние**: Реализовано через Angular Services (Singleton). Состояние (текущий трек, статус воспроизведения, громкость, авторизация, профили пользователей) хранится в `BehaviorSubject` и предоставляется компонентам как `Observable`.
- **Локальное состояние**: Управляется внутри компонентов (например, состояния форм и валидаторы на login/register/profile).

---

## 2. Описание архитектурного подхода

Выбран **компонентный подход** в сочетании с **сервис-ориентированной архитектурой**.

### Разделение ответственности
- Компоненты отвечают за отображение данных (View) и обработку пользовательского ввода.
- Сервисы инкапсулируют бизнес-логику, взаимодействие с API, WebSocket и хранение состояния.

### Изоляция стилей
Используется стандартный Angular-подход со SCSS. Глобальные переменные (цвета, шрифты) вынесены в `:root` (например, `styles.scss`), что позволяет централизованно управлять темой приложения (Dark Theme).

### Glassmorphism UI
В дизайне активно используется полупрозрачность и размытие фона (`backdrop-filter: blur(...)`), реализованные через общие классы/переменные и стили страниц авторизации.

---

## 3. Документация API

Клиент взаимодействует с сервером посредством REST API и WebSocket (STOMP/SockJS).

### Auth API (примерная схема)
| Метод | Эндпоинт | Описание |
|---|---|---|
| POST | `/api/auth/login` | Авторизация пользователя |
| POST | `/api/auth/register` | Регистрация нового аккаунта |

> Тела запросов и ответы зависят от реализации backend (Spring Security + JWT).

### Profile API
| Метод | Эндпоинт | Описание |
|---|---|---|
| GET | `/api/profile/me` | Получить профиль текущего пользователя |
| PUT/PATCH | `/api/profile/username` | Сохранить username |
| PUT/PATCH | `/api/profile/bio` | Сохранить bio |
| GET | `/api/profile/public/{username}` | Публичный профиль (username + bio) для всплывающих подсказок в чате |

### Radio API
| Метод | Эндпоинт | Описание |
|---|---|---|
| GET | `/api/radio/now` | Получить текущий трек (“now playing”) |
| WS topic | `/topic/now-playing` | Реалтайм обновление “now playing” |

### Chat API
| Метод | Эндпоинт | Описание |
|---|---|---|
| GET | `/api/chat/messages/page?page=N&size=S` | Пагинация истории сообщений |
| WS app | `/app/chat.send` | Отправка сообщения |
| WS topic | `/topic/chat` | Реалтайм сообщения чата |

### Analytics / Online listeners
| Канал | Endpoint | Описание |
|---|---|---|
| WS app | `/app/analytics.heartbeat` | Heartbeat “я слушаю/не слушаю” |
| WS topic | `/topic/analytics/online` | Рассылка текущего количества слушателей |
| GET | `/api/admin/analytics/online` | Текущая статистика (для админки/диагностики) |

---

## 4. User flows / Диаграмма навигации

### Сценарий "Гость" (Регистрация/Вход)
1. Пользователь открывает приложение.
2. Переходит на `/login` или `/register`.
3. Заполняет форму → Валидация → Отправка данных.
4. Успех → переход на `/radio`.

### Сценарий "Слушатель"
1. Пользователь открывает `/radio`.
2. `GlobalPlayerComponent` подключается к WebSocket и подгружает `now playing`.
3. Пользователь нажимает Play → плеер начинает воспроизведение.
4. Изменение громкости → обновление `PlayerService` и виджетов.

### Сценарий "Чат + профили"
1. Пользователь открывает чат на странице радио.
2. Сообщения приходят через `/topic/chat`.
3. При наведении на username — фронт запрашивает `/api/profile/public/{username}` и показывает popover (username + bio).

---

## 5. Обоснование выбранного стека

### Framework: Angular
Причина: Angular предоставляет строгую структуру и типизацию (TypeScript) "из коробки", что критически важно для поддержки кода в дипломном проекте. Встроенные механизмы Dependency Injection и модульности упрощают масштабирование.

### UI Library: PrimeNG
Причина: В проекте используются компоненты PrimeNG (например p-button, p-slider, popover/skeleton). PrimeNG предоставляет набор готовых, доступных (a11y) компонентов, что ускоряет разработку интерфейса и повышает кроссбраузерность.

### State Management: RxJS (Services)
Причина: Для приложения потокового аудио (радио) реактивное программирование является лучшим выбором. RxJS позволяет удобно работать с потоками событий (клики, изменение громкости, смена трека) и асинхронными данными API.

### CSS Preprocessor: SCSS
Причина: Использование переменных, вложенности и миксинов позволяет писать чистый и модульный CSS. Это упрощает поддержку темной темы (Dark Mode), которая является основной для приложения.

---

# Тестирование

Проект содержит **минимальный набор Unit-тестов** и **smoke e2e-тесты** (Playwright).  
Это покрывает требования диплома: минимум 3 unit-теста + 1–2 e2e теста.

## Unit-тесты (Angular / Vitest)

Unit-тесты находятся рядом с кодом и имеют расширение `*.spec.ts` (например: `src/app/**/...spec.ts`).

### Запуск
```bash
ng test --watch=false
# или
npm test
```

### Что покрыто
Примеры покрытых unit-тестами частей проекта (минимум 3 ключевых):
- **`PlayerService`**: проверка управления `isPlaying$`, громкостью и логикой toggle.
- **Страницы с формами**: `LoginPage`, `RegisterPage`, `ProfilePage` — базовые smoke/unit проверки создания компонента и/или поведения формы.
- **UI/страницы**: `RadioWidgetComponent`, `RadioPage`, `PublicLayout`, `NotFound` и др. (create tests).

> Примечание: в Vitest нет матчеров `toBeTrue()` / `toBeFalse()`, используйте `toBe(true)` / `toBe(false)` или `toBeTruthy()` / `toBeFalsy()`.

---

## E2E / Integration тесты (Playwright)

E2E тесты лежат в: `src/e2e/e2e/*.e2e.spec.ts`.

Пример: `src/e2e/e2e/smoke.e2e.ts` содержит smoke тесты:
- открытие страницы радио
- открытие страницы логина

### Конфиг Playwright
Файл конфигурации: `src/playwright.config.ts`

### Запуск e2e
```bash
npm run e2e
```

### Запуск e2e с UI (удобно смотреть шаги)
```bash
npm run e2e:ui
```

### Важно про пути к конфигу
Конфиг находится в `src/`, поэтому запускать нужно с `-c ./src/playwright.config.ts` (это уже настроено в `package.json`).

---

## Дополнительно (что можно улучшить при необходимости)
- Добавить e2e тест логина (с моками API или на тестовом backend).
- Добавить unit-тесты на сервисы API (например, `PublicProfileApiService`) через `HttpClientTestingModule`.
- Добавить тест на отображение количества слушателей (через мок `AnalyticsWsService`).

---

## Команды (сводка)

```bash
# Unit tests
npm test
# или
ng test --watch=false

# E2E tests
npm run e2e

# E2E tests with UI
npm run e2e:ui
```

---

## Примечания
- Если во время e2e появляются предупреждения про `"/radio-ws/iframe.html"` — это SockJS fallback (не влияет на прохождение smoke тестов). Чтобы убрать предупреждения, подключайте proxy `/radio-ws` на backend (см. раздел “Прокси на backend”).
